"""
Page de configuration - Param√®tres de l'application
"""

import streamlit as st
import sys
from pathlib import Path
sys.path.append(str(Path(__file__).parent.parent))
from components.styles import render_page_header, render_alert
from components.session import clear_session


def render(api_client):
    """Render la page de configuration"""
    
    render_page_header(
        "Configuration",
        "Personnalisez les param√®tres de Stokkel",
        "‚öôÔ∏è"
    )
    
    tabs = st.tabs(["üîß G√©n√©ral", "ü§ñ Mod√®les IA", "üîê API", "‚ÑπÔ∏è √Ä Propos"])
    
    # TAB 1: PARAM√àTRES G√âN√âRAUX
    with tabs[0]:
        render_general_settings()
    
    # TAB 2: MOD√àLES IA
    with tabs[1]:
        render_ai_settings()
    
    # TAB 3: API
    with tabs[2]:
        render_api_settings(api_client)
    
    # TAB 4: √Ä PROPOS
    with tabs[3]:
        render_about()


def render_general_settings():
    """Onglet des param√®tres g√©n√©raux"""
    
    st.markdown("### üîß Param√®tres G√©n√©raux")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("#### üåç Localisation")
        
        language = st.selectbox(
            "Langue de l'interface",
            options=["Fran√ßais", "English", "Wolof"],
            index=0,
            help="Langue d'affichage de l'application"
        )
        
        currency = st.selectbox(
            "Devise",
            options=["FCFA", "EUR", "USD"],
            index=0,
            help="Devise pour les calculs financiers"
        )
        
        timezone = st.selectbox(
            "Fuseau horaire",
            options=["GMT", "UTC+1", "UTC"],
            index=0,
            help="Fuseau horaire pour les dates"
        )
    
    with col2:
        st.markdown("#### üìÖ Formats")
        
        date_format = st.selectbox(
            "Format de date",
            options=["DD/MM/YYYY", "MM/DD/YYYY", "YYYY-MM-DD"],
            index=0,
            help="Format d'affichage des dates"
        )
        
        number_format = st.selectbox(
            "Format des nombres",
            options=["1 234,56", "1,234.56", "1234.56"],
            index=0,
            help="Format d'affichage des nombres"
        )
    
    st.markdown("---")
    
    st.markdown("#### üì¶ Param√®tres d'Approvisionnement par D√©faut")
    
    col1, col2 = st.columns(2)
    
    with col1:
        default_lead_time = st.number_input(
            "D√©lai de livraison par d√©faut (jours)",
            min_value=1,
            max_value=30,
            value=st.session_state.get('default_lead_time', 7),
            help="D√©lai par d√©faut pour les calculs"
        )
        
        if default_lead_time != st.session_state.get('default_lead_time', 7):
            st.session_state.default_lead_time = default_lead_time
            st.success("‚úÖ Param√®tre mis √† jour")
    
    with col2:
        default_service_level = st.slider(
            "Niveau de service par d√©faut (%)",
            min_value=80,
            max_value=99,
            value=st.session_state.get('default_service_level', 95),
            help="Taux de service par d√©faut"
        )
        
        if default_service_level != st.session_state.get('default_service_level', 95):
            st.session_state.default_service_level = default_service_level
            st.success("‚úÖ Param√®tre mis √† jour")
    
    st.markdown("---")
    
    st.markdown("#### üé® Apparence")
    
    theme = st.selectbox(
        "Th√®me",
        options=["Clair", "Sombre", "Auto"],
        index=0,
        help="Th√®me de couleur de l'interface"
    )
    
    st.info("‚ÑπÔ∏è Le changement de th√®me n√©cessite un rechargement de l'application")
    
    st.markdown("---")
    
    st.markdown("#### üóëÔ∏è Gestion des Donn√©es")
    
    col1, col2 = st.columns(2)
    
    with col1:
        if st.button("üîÑ R√©initialiser les Param√®tres", use_container_width=True):
            st.session_state.default_lead_time = 7
            st.session_state.default_service_level = 95
            st.success("‚úÖ Param√®tres r√©initialis√©s aux valeurs par d√©faut")
            st.rerun()
    
    with col2:
        if st.button("‚ö†Ô∏è Effacer Toutes les Donn√©es", type="secondary", use_container_width=True):
            if st.session_state.get('confirm_clear_all'):
                clear_session()
                st.success("‚úÖ Toutes les donn√©es ont √©t√© effac√©es")
                st.session_state.confirm_clear_all = False
                st.rerun()
            else:
                st.session_state.confirm_clear_all = True
                st.warning("‚ö†Ô∏è Cliquez √† nouveau pour confirmer la suppression")


def render_ai_settings():
    """Onglet des param√®tres IA"""
    
    st.markdown("### ü§ñ Configuration des Mod√®les d'IA")
    
    st.markdown("#### üìà Mod√®le de Pr√©vision")
    
    model_choice = st.selectbox(
        "Algorithme principal",
        options=["Prophet (Recommand√©)", "SARIMA", "LSTM", "Auto-Select"],
        index=0,
        help="Choisissez l'algorithme de pr√©vision √† utiliser"
    )
    
    if model_choice == "Prophet (Recommand√©)":
        st.info("""
        ‚úÖ **Prophet** est recommand√© pour la plupart des cas d'usage.
        
        **Avantages :**
        - G√®re automatiquement la saisonnalit√©
        - Robuste aux valeurs manquantes
        - Rapide et fiable
        - Bon pour les s√©ries avec tendances
        """)
    
    st.markdown("---")
    
    st.markdown("#### ‚öôÔ∏è Param√®tres du Mod√®le")
    
    col1, col2 = st.columns(2)
    
    with col1:
        auto_seasonality = st.checkbox(
            "D√©tection automatique de saisonnalit√©",
            value=True,
            help="Le mod√®le d√©tecte automatiquement les patterns saisonniers"
        )
        
        use_external_vars = st.checkbox(
            "Utiliser les variables externes",
            value=False,
            help="Inclure des variables explicatives suppl√©mentaires (promotions, m√©t√©o, etc.)"
        )
        
        incremental_learning = st.checkbox(
            "Apprentissage incr√©mental",
            value=False,
            help="Le mod√®le s'am√©liore au fil du temps avec les nouvelles donn√©es"
        )
    
    with col2:
        confidence_interval = st.slider(
            "Intervalle de confiance (%)",
            min_value=70,
            max_value=95,
            value=80,
            step=5,
            help="Largeur de l'intervalle de pr√©vision (P10-P90)"
        )
        
        forecast_frequency = st.selectbox(
            "Fr√©quence de mise √† jour",
            options=["Quotidienne", "Hebdomadaire", "Mensuelle", "Manuelle"],
            index=1,
            help="Fr√©quence de recalcul des pr√©visions"
        )
    
    st.markdown("---")
    
    st.markdown("#### üî¨ Param√®tres Avanc√©s")
    
    with st.expander("Afficher les param√®tres avanc√©s"):
        st.warning("‚ö†Ô∏è Modifier ces param√®tres peut affecter la qualit√© des pr√©visions")
        
        col1, col2 = st.columns(2)
        
        with col1:
            changepoint_prior = st.number_input(
                "Changepoint prior scale",
                min_value=0.001,
                max_value=0.500,
                value=0.050,
                step=0.001,
                format="%.3f",
                help="Flexibilit√© du mod√®le aux changements de tendance"
            )
            
            seasonality_prior = st.number_input(
                "Seasonality prior scale",
                min_value=0.1,
                max_value=50.0,
                value=10.0,
                step=0.1,
                help="Force de la composante saisonni√®re"
            )
        
        with col2:
            holidays_prior = st.number_input(
                "Holidays prior scale",
                min_value=0.1,
                max_value=50.0,
                value=10.0,
                step=0.1,
                help="Impact des jours f√©ri√©s sur la pr√©vision"
            )
            
            uncertainty_samples = st.number_input(
                "√âchantillons d'incertitude",
                min_value=100,
                max_value=2000,
                value=1000,
                step=100,
                help="Nombre de simulations pour calculer l'incertitude"
            )
    
    st.markdown("---")
    
    if st.button("üíæ Enregistrer les Param√®tres IA", type="primary", use_container_width=True):
        st.success("‚úÖ Param√®tres IA enregistr√©s avec succ√®s")
        st.info("‚ÑπÔ∏è Les nouveaux param√®tres seront appliqu√©s aux prochaines pr√©visions")


def render_api_settings(api_client):
    """Onglet des param√®tres API"""
    
    st.markdown("### üîê Configuration de l'API")
    
    st.markdown("#### üîó Connexion")
    
    col1, col2 = st.columns(2)
    
    with col1:
        api_url = st.text_input(
            "URL de l'API",
            value=st.session_state.get('api_url', 'http://localhost:8000'),
            help="Adresse du serveur backend"
        )
        
        if api_url != st.session_state.get('api_url'):
            st.session_state.api_url = api_url
            api_client.base_url = api_url
    
    with col2:
        api_token = st.text_input(
            "Token d'authentification",
            value=st.session_state.get('api_token', 'stokkel_mvp_token'),
            type="password",
            help="Cl√© API pour l'authentification"
        )
        
        if api_token != st.session_state.get('api_token'):
            st.session_state.api_token = api_token
            api_client.token = api_token
    
    # Test de connexion
    col1, col2 = st.columns([1, 1])
    
    with col1:
        if st.button("üîÑ Tester la Connexion", use_container_width=True):
            with st.spinner("Test en cours..."):
                response = api_client.health_check()
                
                if response and response.get('status') == 'ok':
                    render_alert(
                        f"Connexion r√©ussie ! Version API: {response.get('version', 'N/A')}",
                        "success",
                        "‚úÖ API Op√©rationnelle"
                    )
                else:
                    render_alert(
                        "Impossible de se connecter √† l'API. V√©rifiez l'URL et le token.",
                        "critical",
                        "‚ùå √âchec de Connexion"
                    )
    
    with col2:
        if st.button("üíæ Enregistrer", type="primary", use_container_width=True):
            st.success("‚úÖ Configuration API enregistr√©e")
    
    st.markdown("---")
    
    st.markdown("#### üìä Statistiques d'Utilisation de l'API")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric(
            "Requ√™tes aujourd'hui",
            st.session_state.stats.get('api_calls_today', 0)
        )
    
    with col2:
        st.metric(
            "Temps de r√©ponse moyen",
            "~250ms"
        )
    
    with col3:
        availability = "99.9%" if api_client.test_connection() else "0%"
        st.metric(
            "Disponibilit√©",
            availability
        )
    
    st.markdown("---")
    
    st.markdown("#### üîí S√©curit√©")
    
    st.info("""
    **Bonnes pratiques de s√©curit√© :**
    
    - üîë Ne partagez jamais votre token API
    - üîÑ Changez r√©guli√®rement votre token
    - üîê Utilisez HTTPS en production
    - üìù Activez les logs d'audit
    """)


def render_about():
    """Onglet √Ä Propos"""
    
    st.markdown("### ‚ÑπÔ∏è √Ä Propos de Stokkel")
    
    st.markdown("""
    <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 2rem; border-radius: 1rem; color: white; margin-bottom: 2rem;">
        <h2 style="color: white; margin: 0 0 1rem 0;">üìä Stokkel</h2>
        <p style="font-size: 1.125rem; margin: 0; opacity: 0.9;">
            Pr√©vision Intelligente des Ventes & Optimisation des Stocks propuls√©e par l'IA
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    st.markdown("#### üéØ Mission")
    st.markdown("""
    Aider les petites et moyennes entreprises (PME) et distributeurs au S√©n√©gal et en Afrique de l'Ouest 
    √† anticiper la demande et optimiser leurs stocks gr√¢ce √† l'intelligence artificielle.
    """)
    
    st.markdown("#### üí° Vision")
    st.markdown("""
    Devenir la plateforme de r√©f√©rence en Afrique de l'Ouest pour une gestion proactive des stocks, 
    r√©duisant les ruptures et le gaspillage, et am√©liorant la rentabilit√© des entreprises locales.
    """)
    
    st.markdown("---")
    
    st.markdown("#### üöÄ Fonctionnalit√©s Principales")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("""
        **üìà Pr√©visions IA**
        - Pr√©visions probabilistes (P10/P50/P90)
        - D√©tection automatique de saisonnalit√©
        - Algorithmes de pointe (Prophet, SARIMA)
        
        **üìä Optimisation des Stocks**
        - Calcul du stock de s√©curit√© dynamique
        - Point de commande optimal
        - Recommandations automatiques
        """)
    
    with col2:
        st.markdown("""
        **üéØ Tableau de Bord**
        - KPIs en temps r√©el
        - Alertes intelligentes
        - Visualisations interactives
        
        **üîå API Flexible**
        - Int√©gration facile
        - API-first architecture
        - Documentation compl√®te
        """)
    
    st.markdown("---")
    
    st.markdown("#### üìä Impact Attendu")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.markdown("""
        <div style="text-align: center; padding: 1rem; background: #fef2f2; border-radius: 0.5rem;">
            <div style="font-size: 2rem; color: #ef4444; font-weight: 700;">-30%</div>
            <div style="color: #6b7280; font-size: 0.875rem;">Ruptures</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col2:
        st.markdown("""
        <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem;">
            <div style="font-size: 2rem; color: #10b981; font-weight: 700;">+25%</div>
            <div style="color: #6b7280; font-size: 0.875rem;">Rotation</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col3:
        st.markdown("""
        <div style="text-align: center; padding: 1rem; background: #eff6ff; border-radius: 0.5rem;">
            <div style="font-size: 2rem; color: #3b82f6; font-weight: 700;">-20%</div>
            <div style="color: #6b7280; font-size: 0.875rem;">Stock dormant</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col4:
        st.markdown("""
        <div style="text-align: center; padding: 1rem; background: #fffbeb; border-radius: 0.5rem;">
            <div style="font-size: 2rem; color: #f59e0b; font-weight: 700;">95%</div>
            <div style="color: #6b7280; font-size: 0.875rem;">Service</div>
        </div>
        """, unsafe_allow_html=True)
    
    st.markdown("---")
    
    st.markdown("#### üìö Ressources")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("""
        - üìñ [Documentation](https://docs.stokkel.io)
        - üéì [Tutoriels](https://tutorials.stokkel.io)
        - üíª [GitHub](https://github.com/stokkel)
        """)
    
    with col2:
        st.markdown("""
        - üìß [Support](mailto:support@stokkel.io)
        - üí¨ [Communaut√©](https://community.stokkel.io)
        - üì± [Twitter](https://twitter.com/stokkel)
        """)
    
    st.markdown("---")
    
    st.markdown("#### üìÑ Informations Techniques")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("""
        **Version de l'Application**
        - Dashboard: v1.0.0
        - API: v1.0.0
        - Python: 3.10+
        """)
    
    with col2:
        st.markdown("""
        **Technologies Utilis√©es**
        - Backend: FastAPI, Python
        - IA: Prophet, Scikit-learn
        - Frontend: Streamlit, Plotly
        """)
    
    st.markdown("---")
    
    st.markdown("""
    <div style="text-align: center; padding: 2rem; background: #f9fafb; border-radius: 0.5rem;">
        <p style="color: #6b7280; margin: 0;">
            ¬© 2024 Stokkel. Tous droits r√©serv√©s.<br>
            Fait avec ‚ù§Ô∏è pour les PME africaines
        </p>
    </div>
    """, unsafe_allow_html=True)